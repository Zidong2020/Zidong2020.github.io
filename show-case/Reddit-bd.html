
<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Zidong Xu - Reddit - bd</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <!--Google fonts links-->
        <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet">


        <link rel="stylesheet" href="assets/css/fonticons.css">
        <link rel="stylesheet" href="assets/css/slider-pro.css">
        <!--<link rel="stylesheet" href="assets/css/stylesheet.css">-->
        <link rel="stylesheet" href="assets/css/font-awesome.min.css">
        <link rel="stylesheet" href="assets/css/bootstrap.min.css">


        <!--For Plugins external css-->
        <link rel="stylesheet" href="assets/css/plugins.css" />

        <!--Theme custom css -->
        <link rel="stylesheet" href="assets/css/style.css">

        <!--Theme Responsive css-->
        <link rel="stylesheet" href="assets/css/responsive.css" />

        <script src="assets/js/vendor/modernizr-2.8.3-respond-1.4.2.min.js"></script>
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    </head>

    <body data-spy="scroll" data-target=".navbar-collapse">
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
        
        <div class='preloader'><div class='loaded'>&nbsp;</div></div>

        <!--Navigation bar-->
        <div id="nav-placeholder">
            
        </div>

        <script>
        $(function(){
          $("#nav-placeholder").load("nav.html");
        });
        </script>
        <!--end of Navigation bar-->



        <!-- Blog Section -->
        <section id="bloginner" class="bloginner sections margin-top-120">
            <div class="container">
                <div class="row">
                    <div class="col-sm-12">
                        <div class="head_title text-center">
                            <h3>Analyze Reddit data with Azure </h3>

                            <h5>6 December 2022</h5>
                            Authors: Zidong Xu

                        </div><!-- End of head title -->
                        <div class="main_bloginner_area">
                            <div class="row">
                                <div class="col-sm-10 col-sm-offset-1">
                                    <div class="main_bloginner_content">

                                      <table style="margin:auto;">
                                        <tr>
                                          <td>
                                            <div class="single_bloginner s_blogIner_1 text-center">
                                              <img src="assets/images/bigdata-images/azure_logo.png" alt="" width="150" height="120"/>
                                            </div>
                                          </td>
                                  
                                          <td>
                                            <div class="single_bloginner s_blogIner_1 text-center">
                                                  <img src="assets/images/bigdata-images/reddit_logo.png" alt="" width="110" height="70"/>
                                            </div>
                                          </td>
                                        </tr>
                                      </table>

                                       
                                        <div class="single_bloginner s_blogIner_2 margin-top-80">
                                            <div class="separator2"></div>
                                            <p><strong>Focus on teenager related subbreddits: </strong>
                                            </p>

                                            <ul>
                                              <li>
                                                &#9749; EDA 
                                              </li>

                                              <li>
                                                &#9749; NLP (NLTK & Spark NLP)
                                              </li>

                                              <li>
                                                &#9749; Machine Learning Pipelines (Spark ML) <br>
                                                &nbsp; &nbsp; -- <strong>Random Forests </strong> & <strong>Logistic Regression </strong>

                                              </li>
                                          
                                              
                                            </ul>
                                            

                                        </div>

                                        <div class="single_bloginner s_blogIner_3 margin-top-60">
                                            <h4>Project Background</h4>
                                            <br>

                                            <p>How to better operate Reddit, it is very important to understand users, including understanding the topics they care about, understanding their usage habits and so on.
                                              The Word Cloud in the figure below uses NLTK to clean up the text output by the user.
                                              From the Word Cloud, we noticed that the topics that teenagers focus on mainly focus on school, family and emotion.
                                            </p>

                                            <div class="single_bloginner s_blogIner_1 text-center">
                                              <img src="assets/images/bigdata-images/intro_png.png" alt="" width="150" height="300"/>
                                            </div>

                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-sm-12">
                                <div class="single_bloginner s_blogIner_4 single_bloginner_bottom_heading margin-top-80">
                                    <div class="separator2"></div>
                                    <h4>Tutorial </h4>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-sm-10 col-sm-push-1">
                                    <div class="single_bloginner s_blogIner_5 margin-top-60">
                                       
                                        <h3 style='font-family: "Times New Roman", Times, serif;'>
                                          <strong>Exploratory data analysis</strong>
                                        </h3>
                                            <br>
                                                <p>
                                                  After basic data cleaning procedures, such as removing unneeded variables and removing rows with NA, the two datasets we are going to use contain metadata of submissions and comments from subreddits that contains the words <strong>teenagers </strong>. The submission dataset is a collection of the reddit submissions including <strong>1770430 rows</strong> and 11 variables in total, while the comment dataset is a collection of the comments under different posts containing <strong>38152167 rows </strong> and 11 variables. Below are some important columns we would like to use later.
                                                </p>

                                                <div class="single_bloginner s_blogIner_1 text-center">
                                                <img src="assets/images/bigdata-images/submissions_first5.png" alt="" width="800" height="280"/>
                                                </div>
                                                <br>

                                                <div class="single_bloginner s_blogIner_1 text-center">
                                                <img src="assets/images/bigdata-images/comments_first5.png" alt="" width="800" height="280"/>
                                                </div>
                                                <br><br>

                                                <p style="background-color:rgb(237, 233, 233);">
                                                  <font size="-0.4" >
                                                  <code>
                                                    <strong># transform1: change utc to readable timestamp format </strong><br>
                                                    teenagers_comments = teenagers_comments.withColumn("created_time", to_timestamp(teenagers_comments["created_utc"])) <br><br>
                                                    <strong># transform2: extract hour part from  readable timestamp "created_time" </strong><br>
                                                    comments_hour = teenagers_comments.limit(1000000).toPandas()["created_time"].apply(lambda x: x.hour).to_frame() <br>
                                                   
                                                    
                                                  </code>
                                                  </font>
                
                                                </p>

                                                <div class="single_bloginner s_blogIner_1 text-center">
                                                <img src="assets/images/bigdata-images/Comment_activity_over_time.png" alt="" width="800" height="580"/>
                                                </div>

                                                </p>
                                                This plot shows that teens are more active at midnight and less frequently use Reddit in the morning. Thus, if someone wants more attention, they could send a submission or comment at midnight.
                                                <p>

                                                
                                                
                                                
                                                                             
                                        <br>
                                        <hr>
                                     
                                    
                                        <h3 style='font-family: "Times New Roman", Times, serif;'>
                                          <strong>Text data Preprocessing </strong>
                                        </h3>
                                            <br>
                                                <p>
                                                  <strong>a. Regular expressions & NLTK: </strong>
                              
                                                  <p style="background-color:rgb(237, 233, 233);">
                                                    <font size="-0.4" >
                                                    <code>
                                                      <strong># Clean the variable "selftext" of the teenager_submissions table: </strong><br>
                                                      Sub_text = teenagers_submissions.select("selftext").toPandas() <br>
                                                      Sub_text = Sub_text.sample(frac=0.01, replace=True, random_state=124) <br>
                                                      def clean_text(text): <br>
                                                      &nbsp; text = text.lower() <br>
                                                      &nbsp; text = re.sub(r'[^(a-zA-Z)\s]','', text) <br>
                                                      &nbsp; text = re.sub('\[[^]]*\]', '', text) <br>  
                                                      &nbsp; return text <br>

                                                      Sub_text["selftext"] = Sub_text["selftext"].apply(clean_text) <br><br>
                                                      
                                                      nltk.download("stopwords") <br>
                                                      stop = stopwords.words("english") <br><br>

                                                      Sub_text["selftext"] = Sub_text["selftext"].apply(lambda x: ' '.join([word for word in x.split() if word not in (stop)]))
 
                                                    </code>
                                                    </font>
                                                  </p>
                                                </p>

                                                <p>
                                                  <strong>b. johnsnowlabs sparkNLP (Build Pipelines): </strong>
                                                  <p style="background-color:rgb(237, 233, 233);">
                                                    <font size="-0.4">
                                                    <code>
                                                      <strong># Clean the variable "body" of the teenager_comments table: </strong><br>
                                                      documentAssembler = DocumentAssembler().setInputCol("body").setOutputCol("document") <br><br>
                                                      tokenizer = Tokenizer().setInputCols(["document"]).setOutputCol("token") <br><br>
                                                      
                                                      normalizer = ( <br>
                                                      &nbsp;&nbsp;Normalizer().setInputCols(["token"]).setOutputCol("normalized").setLowercase(True) <br>
                                                      &nbsp;) <br><br>

                                                      stop_words = ( <br>
                                                      &nbsp; StopWordsCleaner.pretrained("stopwords_en", "en") <br>
                                                      &nbsp;&nbsp; .setInputCols(["normalized"]) <br>
                                                      &nbsp;&nbsp; .setOutputCol("clean_normalized") <br>
                                                      &nbsp;&nbsp; .setCaseSensitive(False) <br>
                                                      &nbsp;) <br><br>

                                                      stemmer = Stemmer().setInputCols(["clean_normalized"]).setOutputCol("stem") <br><br>

                                                      <strong># finisher converts tokens to human-readable output </strong><br>
                                                      finisher = Finisher().setInputCols(["stem"]).setCleanAnnotations(False) <br><br>

                                                      pipeline = Pipeline().setStages(<br>
                                                        &nbsp;[ <br>
                                                        &nbsp;&nbsp; documentAssembler, <br>
                                                        &nbsp;&nbsp; tokenizer, <br>
                                                        &nbsp;&nbsp; normalizer, <br>
                                                        &nbsp;&nbsp; stop_words, <br>
                                                        &nbsp;&nbsp; stemmer, <br>
                                                        &nbsp;&nbsp; # lemmatizer, <br>
                                                        &nbsp;&nbsp; finisher, <br>
                                                        &nbsp;&nbsp;] <br>
                                                        &nbsp;) <br><br>

                                                      <strong># try and show the process use mini sample </strong><br>
                                                      teenagers_comments_mini = teenagers_comments.limit(1000).toPandas()["body"] <br>
                                                      teenagers_comments_subreddit_mini = teenagers_comments.limit(1000).toPandas()["body"]
                                                      p_model = pipeline.fit(spark.createDataFrame([[""]]).toDF("body")) <br><br>
                                                      
                                                      df = spark.createDataFrame(pd.DataFrame({"body": teenagers_comments_mini})) <br>
                                                      result = p_model.transform(df) <br>


                                                      
                                                    </code>
                                                    </font>
                                              </p>

                                        <br>
                                        <hr>
                                    
                                    
                                        <h3 style='font-family: "Times New Roman", Times, serif;'>
                                          <strong>Machine Learning Pipelines (Spark ML) </strong>
                                        </h3>
                                        <br>  
                                          
                                        <p>
                                          In this part, we want to show how to create spark ML pipelines. For example, we make a dummy variable "author_grade" label and use other variables, such as num_comments, selftext_len, and hour when submission is published, as predictors.  Then we build <strong>Random Forests </strong> to predict the most important predicator, and the result shows variable num_comments wins. 
                                          We also use <strong>Accuracy, Confusion Matrix, and AUC</strong> as criteria to evaluate the prediction ability of our model.
                                        </p>
                                          
                                        <p>
                                          <strong>a. Random Forest (example): </strong>
                      
                                          <p style="background-color:rgb(237, 233, 233);">
                                            <font size="-0.4" >
                                            <code>
                                              stringIndexer_author_grade = StringIndexer( <br>
                                                &nbsp;&nbsp; inputCol="author_grade", outputCol="author_grade_label" <br>
                                                &nbsp;) <br>
                                              stringIndexer_subreddit = StringIndexer(inputCol="subreddit", outputCol="subreddit_ix") <br><br>
                                              
                                              onehot_subreddit = OneHotEncoder(inputCol="subreddit_ix", outputCol="subreddit_vec") <br><br>
                                              
                                              vectorAssembler_features = VectorAssembler( <br>
                                                &nbsp;&nbsp; inputCols=["num_comments", "selftext_len", "hour", "subreddit_vec"], <br>
                                                &nbsp;&nbsp; outputCol="features", <br>
                                                &nbsp;) <br><br>

                                                <strong># Fine turn parameters: change the number of trees </strong><br>
                                                rf = RandomForestClassifier( <br>
                                                &nbsp;&nbsp; labelCol="author_grade_label", featuresCol="features", numTrees=10 <br>
                                                &nbsp;) <br><br>
                                                 
                                                labelConverter = IndexToString( <br>
                                                &nbsp;&nbsp; inputCol="prediction", outputCol="predicted_author_grade", labels=["normal", "top"] <br>
                                                &nbsp;) <br><br>
                                                 
                                                pipeline_rf = Pipeline( <br>
                                                &nbsp;&nbsp; stages=[ <br>
                                                &nbsp;&nbsp;&nbsp;  stringIndexer_author_grade, <br>
                                                &nbsp;&nbsp;&nbsp; stringIndexer_subreddit, <br>
                                                &nbsp;&nbsp;&nbsp;  onehot_subreddit, <br>
                                                &nbsp;&nbsp;&nbsp;  vectorAssembler_features, <br>
                                                &nbsp;&nbsp;&nbsp;  rf, <br>
                                                &nbsp;&nbsp;&nbsp;  labelConverter, <br>
                                                &nbsp;&nbsp; ] <br>
                                                &nbsp;) <br><br>

                                                <strong># Fit the model </strong><br>
                                                &nbsp; model_rf = pipeline_rf.fit(train_data) <br><br>

                                            </code>
                                            </font>
                                          </p>
                                        </p>

                                        <p>
                     
                                          <p style="background-color:rgb(237, 233, 233);">
                                            <font size="-0.4" >
                                            <code>
                                              <strong># Plot to find important features:  </strong><br>
                                              import matplotlib.pyplot as plt <br><br>

                                              rf_important_featrues_df = pd.DataFrame( <br>
                                              &nbsp; &nbsp; zip(model_rf.stages[-3].getInputCols(), model_rf.stages[-2].featureImportances) <br>
                                              &nbsp; ) <br>
                                              rf_important_featrues_df = rf_important_featrues_df.rename( <br>
                                              &nbsp; &nbsp; columns={0: "InputCols", 1: "featureImportances"} <br>
                                              &nbsp; ) <br>
                                              rf_important_featrues_df = rf_important_featrues_df.sort_values( <br>
                                              &nbsp; &nbsp; by=["featureImportances"] <br>
                                              &nbsp; ) <br>


                                              plt.style.use("ggplot") <br><br>
 
                                              plt.barh( <br>
                                              &nbsp; &nbsp;  rf_important_featrues_df["InputCols"], <br>
                                              &nbsp; &nbsp;  rf_important_featrues_df["featureImportances"], <br>
                                              &nbsp; &nbsp;  color="#F79604", <br>
                                              &nbsp; ) <br>
                                              plt.grid(False) <br><br>
                                              
                                              plt.title("Feature Importances", fontdict={"fontsize": 20}) <br>
                                              plt.ylabel("features", fontdict={"fontsize": 15}) <br>
                                              plt.xlabel("important values", fontdict={"fontsize": 15}) <br>
                                              
                                              plt.savefig("../../[your_file_path]") <br>
                                             
                                            </code>
                                            </font>
                                          </p>
                                        </p>

                                        <P>
                                          <div class="single_bloginner s_blogIner_1 text-center">
                                            <img src="assets/images/bigdata-images/Feature_Importances.png" alt="" width="400" height="250"/>
                                          </div>
                                        </P>
                                       
                                       

                                        <p>
                                          <strong>b. Model evaluation: </strong><br><br>

                                          &#9749; Accuracy <br>
                                            <p style="background-color:rgb(237, 233, 233);">
                                              
                                              <font size="-0.4" >
                                              <code>
                                                evaluatorRF = MulticlassClassificationEvaluator( <br>
                                                  &nbsp; &nbsp; labelCol="author_grade_label", predictionCol="prediction", metricName="accuracy" <br>
                                                  &nbsp; ) <br>
                                                
                                                accuracy_rf = evaluatorRF.evaluate(predictions_rf) <br><br>
                                                
                                                print("RF_Accuracy = %g" % accuracy_rf) <br>
                                                print("RF_Test Error = %g" % (1.0 - accuracy_rf)) <br>
                                                
                                              </code>
                                              </font>
                                            </p>
                                          </p>

                                        &#9749; Confusion Matrix <br>
                                          <p style="background-color:rgb(237, 233, 233);">
                                            
                                            <font size="-0.4" >
                                            <code>
                                              import plotly.express as px <br><br>
 
                                              fig = px.imshow(cm, color_continuous_scale="gnbu", <br>
                                              &nbsp; labels=dict(x="Predicted Class", y="True Class", color="labels number"), <br>
                                              &nbsp; x=["T", "F"],<br>
                                              &nbsp; y=["T", "F"],<br>
                                              &nbsp; text_auto=True) <br>
                                              fig.show()
                                              
                                            </code>
                                            </font>
                                          </p>
                                        </p>


                                        &#9749; AUC <br>
                                          <p style="background-color:rgb(237, 233, 233);">
                                            
                                            <font size="-0.4" >
                                            <code>
                                              evaluatorRF = BinaryClassificationEvaluator(  <br>
                                                &nbsp;&nbsp;   labelCol="author_grade_label",  <br>
                                                &nbsp;&nbsp;   rawPredictionCol="prediction",  <br>
                                                &nbsp;&nbsp;  metricName="areaUnderROC",  <br>
                                                &nbsp; )  <br>
                                              roc_result_rf = evaluatorRF.evaluate(predictions_rf)  <br> <br>
                                              print("RF_Accuracy = %g" % roc_result_rf)  <br>
                                              
                                            </code>
                                            </font>
                                          </p>
                                        </p>

                                        <ul>
                                          <li>
                                          <a href=" https://gu-anly502.github.io/fall-2022-reddit-big-data-project-project-group-14/code/ml/RF_LR.html">Complete Code for this part</a> 
                                          </li>
                                        </ul>    

                                        <br>
                                        <hr>
                                    
                                        
                                        <h3 style='font-family: "Times New Roman", Times, serif;'>
                                          <strong>Conclusions</strong>
                                        </h3>
                                        <br>
                                        <p>
                                          In this blog, we first use Word Cloud to give an important impression about what the text says, then show how to use NLTK and spark NLP to do basic text cleaning and finally show how to use spark ML to build pipelines. Although we mention some business sense when analyzing data, we still need to consider more. If you are interested in this project, you can click the link below, our group mate analysis from other angles, or contact me directly through email.
                                        </p>
                                       
                                        <br>
                                        <hr>
                                       
                                        
                                        <h3 style='font-family: "Times New Roman", Times, serif;'>
                                          <strong>Links for more details</strong>
                                        </h3>
                                                <br>
                                                <ul>
                                                  <li>
                                                    Complete Project: <a href="https://gu-anly502.github.io/fall-2022-reddit-big-data-project-project-group-14/">Reddit Discussion on Teenagers</a> 
                                                  </li>
                                  
                                                </ul>
                                              
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div><!-- End of col-sm-12 -->
                </div><!-- End of row -->
            </div><!-- End of Container -->
        </section><!-- End of Blog Section -->



        <div class='preloader'><div class='loaded'>&nbsp;</div></div>
        <!--Footer bar-->
        <div id="footer-placeholder">
          
        </div>

        <script>
        $(function(){
          $("#footer-placeholder").load("footer.html");
        });
        </script>
        <!--end of Footer bar-->

        

        <!-- START SCROLL TO TOP  -->

        <div class="scrollup">
            <a href="#"><i class="fa fa-chevron-up"></i></a>
        </div>

        <script src="assets/js/vendor/jquery-1.11.2.min.js"></script>
        <script src="assets/js/vendor/bootstrap.min.js"></script>

        <script src="assets/js/jquery.easing.1.3.js"></script>
        <script src="assets/js/masonry/masonry.min.js"></script>
        <script type="text/javascript">
            $('.mixcontent').masonry();
        </script>

        <script src="assets/js/jquery.sliderPro.min.js"></script>
        <script type="text/javascript">
            $(document).ready(function ($) {
                $('#example3').sliderPro({
                    width: 960,
                    height: 200,
                    fade: true,
                    arrows: false,
                    buttons: true,
                    fullScreen: false,
                    shuffle: true,
                    smallSize: 500,
                    mediumSize: 1000,
                    largeSize: 3000,
                    thumbnailArrows: true,
                    autoplay: false,
                    thumbnailsContainerSize: 960

                });
            });
        </script>
        <script src="assets/js/plugins.js"></script>
        <script src="assets/js/main.js"></script>

    </body>
</html>
